@using bunqAggregation.Models;
@using bunqAggregation.Core;
@using Microsoft.AspNetCore.Mvc;
@model AddCurrentAccountModel
@{
    ViewData["Title"] = "Manage";
    string access_token = (string)ViewData["access_token"];
}
<h2>@ViewData["Title"]</h2>

<h3>Add Current Accounts</h3>
<img id="qrcode" src="@Model.QRCode"/>
<div id="validating">
    bunqAggregation is waiting for acceptance of the Connect...
</div>
<div id="completed" style="display: none">
    bunqAggregation - is connected with:<br><br>
    <span id="description"></span><br>
    <span id="iban"></span>
</div>
<div id="error" style="display: none">
    bunqAggregation - an error has occurred: <span id="message"></span>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
<script language="javascript">
function checkstatus() {
    url = "@Config.Service.Url/api/accounts/status";
    data = {
        "data" : {
            "draftid" : @Model.DraftId
        }
    };

    console.log(data);
    
    var request = $.ajax({
        url : url,
        method : "POST",
        headers: {"Authorization" : "Bearer @access_token"},
        data : JSON.stringify(data),
          contentType : "application/json"
    });

    request.done(function(values,statusText,jqXHR) {
        console.log(values);
        if (typeof values["data"] != "undefined") {
            $("#description").append(values["data"]["description"]);
            $("#iban").append(values["data"]["iban"]);
            $("#qrcode").hide();
            $("#validating").hide();
            $("#completed").show();
            location.hash = "completed";
        }
        if (typeof values["error"] != "undefined") {
            $("#message").append(values["error"]["message"]);
            $("#qrcode").hide();
            $("#validating").hide();
            $("#error").show();
        }
    }); 

    request.fail(function(values,statusText,jqXHR) {
    });
    
};
checkstatus();
</script>